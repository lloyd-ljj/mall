# 098765432项目背景

## 1.分布是基础概念

### 微服务

微服务架构风格，就是将单独的应用程序开发为一套小服务，每个小服务运行在自己的进程中，并使用轻量级机制通信（HTTP API）。拒绝大型单体应用，基于业务边界进行微服务微化拆分，各个服务独立部署运行。

---

### 集群&分布式&节点

集群是物理形态，分布式是工作方式。集群指的是将几台服务器集中在一起，实现同一业务；分布式是指不同的业务分布在不同的地方。
例如：京东是一个分布式系统，众多业务运行在不同的机器，所有业务构成一个大型的业务集群。
节点：集群中的一个服务器。
分布式中每一个节点，都可以做集群。但集群并不一定是分布式的。

---

### 远程调用

分布式系统中，各个服务可能处于不同主机，服务之间的调用称作远程调用。SpringCloud中使用HTTP+JSON完成。

---

### 负载均衡

为了使每一个服务器不要太忙或太闲，可以使用负载均衡来调用服务器，提升网站健壮性。

常见算法：

- 轮询：依次从第一个到最后一个
- 最小连接：优先选择连接少、压力小的服务器
- 散列：同一个用户分配到同一个服务器

---

### 服务注册/发现&注册中心

A服务调用B服务，可以通过注册中心找到B服务的服务器，从而避免调用不可用的服务

---

### 服务熔断&服务降级

在微服务架构中，微服务之间通过网络进行通信，存在相互依赖，其中一个服务不可用时，有可能会造成雪崩效应，需要容错机制去保护。

（1）服务熔断：设置服务的超时时间，当被调用的服务经常失败达到某个阈值，可以开启断路保护机制，后来的请求不再去调用该服务，直接返回默认的数据。
（2）服务降级：当系统处于高峰期，系统资源紧缺，可以让非核心业务降级运行。某些服务不处理、或者简单处理（抛异常、返回null等）

---

### API网关

在微服务架构中，API Gateway作为整体架构的重要组件，抽象了微服务中需要的公共功能，同时提供了客户端负载均衡、服务自动熔断、灰度发布、统一认证、限流流控、日志统计等功能，帮助解决API管理。

---

# 环境配置

## docker

### mysql

```
docker run --name mysql-3306 -p 3306:3306 \
-v /mydata/mysql/log:/var/log/mysql \
-v /mydata/mysql/data:/var/lib/mysql \
-v /mydata/mysql/conf:/etc/mysql \
-v /mydata/mysql/mysql-files:/var/lib/mysql-files \
-e MYSQL_ROOT_PASSWORD=root \
-d mysql
```

```
// 进入容器
docker exec -it mysql-3306 bash
// 登录mysql
mysql -u root -p 
// 修改密码
ALTER USER 'root'@'localhost' IDENTIFIED BY 'lianlianjie';

// 8.0版本后，设置访问权限允许远程访问
mysql -u root -p
use mysql;
//Mysql默认不允许远程登录，所以需要开启远程访问权限
select user,authentication_string,host from user;
update user set host = '%' where user = 'root';
FLUSH PRIVILEGES;
//navicat 连接 mysql 出现`Client does not support authentication protocol requested by server`
alter user 'root'@'%' identified with mysql_native_password by 'lianlianjie';

```

---

### redis

```
docker run -p 6379:6379 --name redis-6379 \
-v /mydata/redis/data:/data \
-v /mydata/redis/conf/redis.conf:/etc/redis/redis.conf \
-d redis redis-server /etc/redis/redis.conf
```

开启客户端

```
docker exec -it redis-6379 redis-cli
```

在redis.conf中开启aof持久化

```
appendonly yes
```

---

## 插件

### Lombok

### MyBatisX

---

### Linux固定ens33的ip

```shell
sudo ifconfig ens33 192.168.248.130
```

---

# 数据库结构

- sms：优惠券/营销数据库，端口7000
- pms：商品数据库，端口10000
- wms：库存数据，端口11000
- ums：用户数据库，端口8000
- oms：订单数据库，端口9000

---

# 注册中心、配置中心、网关

SpringCloud Alibaba - Nacos：注册中心（服务发现与注册）、配置中心（动态配置管理）

SpringCloud - Ribbon：负载均衡

SpringCloud - Feign：调用远程服务，声明式HTTP客户端

SpringCloud Alibaba - Sentinel：流量控制、熔断降级、系统负载保护

SpringCloud - Gateway：API网关控制

SpringCloud - Sleuth：调用链监控

SpringCloud Alibaba - Seata：分布式事务解决方案

---

## Nacos注册中心

### docker安装：

```shell
// 拉取
docker pull nacos/nacos-server
// 启动
docker run --env MODE=standalone --restart=always --name nacos -d -p 8848:8848 nacos/nacos-server:latest
```

### 配置：

```properties
spring:
  cloud:
    nacos:
      discovery:
        server-addr: 192.168.248.130:8848
  application:
    name: mall-coupon
```

```java
// application上使用注解
@EnableDiscoveryClient
@SpringBootApplication
```

### 访问：

```
http://192.168.248.130:8848/nacos
```

---

### Feign远程调用

```

/**
 * 1、想要远程调用别的服务
 * 1）、引入open-feign
 * 2）、编写一个接口，告诉SpringCloud这个接口需要调用远程服务
 *   1、声明接口的每一个方法都是调用哪个远程服务的那个请求
 * 3）、开启远程调用功能
 */
```

---

## Nacos配置中心

```
/**
 * 1、如何使用Nacos作为配置中心统一管理配置
 *
 * 1）、引入依赖，
 *         <dependency>
 *             <groupId>com.alibaba.cloud</groupId>
 *             <artifactId>spring-cloud-starter-alibaba-nacos-config</artifactId>
 *         </dependency>
 * 2）、创建一个bootstrap.properties。
 *      spring.application.name=gulimall-coupon
 *      spring.cloud.nacos.config.server-addr=127.0.0.1:8848
 * 3）、需要给配置中心默认添加一个叫 数据集（Data Id）gulimall-coupon.properties。默认规则，应用名.properties
 * 4）、给 应用名.properties 添加任何配置
 * 5）、动态获取配置。
 *      @RefreshScope：动态获取并刷新配置
 *      @Value("${配置项的名}")：获取到配置。
 *      如果配置中心和当前应用的配置文件中都配置了相同的项，优先使用配置中心的配置。
 *
 * 2、细节
 *  1）、命名空间：配置隔离；
 *      默认：public(保留空间)；默认新增的所有配置都在public空间。
 *      1、开发，测试，生产：利用命名空间来做环境隔离。
 *         注意：在bootstrap.properties；配置上，需要使用哪个命名空间下的配置，
 *         spring.cloud.nacos.config.namespace=9de62e44-cd2a-4a82-bf5c-95878bd5e871
 *      2、每一个微服务之间互相隔离配置，每一个微服务都创建自己的命名空间，只加载自己命名空间下的所有配置
 *
 *  2）、配置集：所有的配置的集合
 *
 *  3）、配置集ID：类似文件名。
 *      Data ID：类似文件名
 *
 *  4）、配置分组：
 *      默认所有的配置集都属于：DEFAULT_GROUP；
 *      1111，618，1212
 *
 * 项目中的使用：每个微服务创建自己的命名空间，使用配置分组区分环境，dev，test，prod
 *
 * 3、同时加载多个配置集
 * 1)、微服务任何配置信息，任何配置文件都可以放在配置中心中
 * 2）、只需要在bootstrap.properties说明加载配置中心中哪些配置文件即可
 * 3）、@Value，@ConfigurationProperties。。。
 * 以前SpringBoot任何方法从配置文件中获取值，都能使用。
 * 配置中心有的优先使用配置中心中的，
 *
 *
 */
```

```properties
# bootstrap.properties demo
server.port=7000
spring.cloud.nacos.config.server-addr=192.168.248.130:8848

# 命名空间
spring.cloud.nacos.config.namespace=0b971b26-2226-4438-af2c-aa6874d02f3f
# 配置分组
#spring.cloud.nacos.config.group=DEFAULT_GROUP

spring.cloud.nacos.config.extension-configs[0].data-id=datasource.yml
spring.cloud.nacos.config.extension-configs[0].group=dev
spring.cloud.nacos.config.extension-configs[0].refresh=true

spring.cloud.nacos.config.extension-configs[1].data-id=mybatis.yml
spring.cloud.nacos.config.extension-configs[1].group=dev
spring.cloud.nacos.config.extension-configs[1].refresh=true

spring.cloud.nacos.config.extension-configs[2].data-id=other.yml
spring.cloud.nacos.config.extension-configs[2].group=dev
spring.cloud.nacos.config.extension-configs[2].refresh=true

spring.cloud.nacos.config.extension-configs[3].data-id=mall-coupon.properties
spring.cloud.nacos.config.extension-configs[3].group=DEFAULT_GROUP
spring.cloud.nacos.config.extension-configs[3].refresh=true
```

---

## GateWay

- Route：路由，转到指定地址
- Predicate：断言，判断请求是否可以路由到指定地址
- Filter：过滤器，请求经过过滤器进行识别判断、修改等操作

### 工作流程

客户端向Spring Cloud Gateway发出请求，如果请求符合某个路由规则（断言成功），则将其发送到指定服务，在发送到该服务之前，会经过一系列过滤器。

官方文档

https://cloud.spring.io/spring-cloud-static/spring-cloud-gateway/2.2.2.RELEASE/reference/html/

---

# 前端

##  ES6

ECMAScript是浏览器脚本语言的规范，js等是规范的具体实现

## VUE

---

# OSS对象存储

doc:

https://help.aliyun.com/document_detail/31947.html?spm=5176.8465980.entries.8.4c711450cYiREB

**服务端签名后直传**：

- 用户向应用服务器请求上传签名
- 应用服务器返回上传签名
- 用户直接上传数据到oss

避免了上传过多数据占用服务器带宽，也保证了数据的安全

---

# JSR303数据校验

```
 *   1）、给Bean添加校验注解:javax.validation.constraints，并定义自己的message提示
 *   2)、开启校验功能@Valid
 *      效果：校验错误以后会有默认的响应；
 *   3）、给校验的bean后紧跟一个BindingResult，就可以获取到校验的结果
 *   4）、分组校验（多场景的复杂校验）
 *         1)、	@NotBlank(message = "品牌名必须提交",groups = {AddGroup.class,UpdateGroup.class})
 *          给校验注解标注什么情况需要进行校验
 *         2）、@Validated({AddGroup.class})
 *         3)、默认没有指定分组的校验注解@NotBlank，在分组校验情况@Validated({AddGroup.class})下不生效，只会在@Validated生效；
 *
 *   5）、自定义校验
 *      1）、编写一个自定义的校验注解
 *      2）、编写一个自定义的校验器 ConstraintValidator
 *      3）、关联自定义的校验器和自定义的校验注解
         *      @Documented
         * @Constraint(validatedBy = { ListValueConstraintValidator.class【可以指定多个不同的校验器，适配不同类型的校验】 })
         * @Target({ METHOD, FIELD, ANNOTATION_TYPE, CONSTRUCTOR, PARAMETER, TYPE_USE })
         * @Retention(RUNTIME)
         * public @interface ListValue {
         
 * 4、统一的异常处理
 * @ControllerAdvice
 *  1）、编写异常处理类，使用@ControllerAdvice。
 *  2）、使用@ExceptionHandler标注方法可以处理的异常。
```

通过JSR303进行数据校验，并对所有异常通过ExceptionHandler（SpringMVC里的注解）进行处理

**分组校验：**

比如新增和修改，修改有些字段可以不写，但新增必须写。

----

# SPU、SKU

### spu

standard product unit(标准化产品单元)，是商品信息聚合的最小单位，是一组可复用、易检索的标准化信息的集合，该集合描述了一个产品的特性

### sku

stock keeping unit(库存量单位) SKU即库存进出计量的单位（买家购买、商家进货、供应商备货、工厂生产都是依据SKU进行的）。

pms_attr_group	
pms_attr_attrgroup_relation	
pms_attr	
pms_product_attr_value	
pms_spu_info	
pms_sku_info
pms_sku_images
pms_sku_sale_attr_values

<img src="学习笔记.assets/image-20200527152021832.png" alt="image-20200527152021832" style="zoom: 33%;" />

<img src="学习笔记.assets/image-20200527152208702.png" alt="image-20200527152208702" style="zoom:33%;" />